---
title: 'Lab #03: Probability and Teamwork'
subtitle: 'due Friday, September 16, 4:00 PM'
output:
  tufte::tufte_html:    
    css: "sta199-labs.css"
    tufte_variant: envisioned
    highlight: pygments
    toc: no
    toc_depth: 1
  html_document:
    toc: no
    toc_depth: '1'
    df_print: paged
link-citations: yes
editor_options:
  chunk_output_type: console
---

## Goals

- Practice collaboration using the data science workflow
- Use probability to explore global health data on monkeypox in non-endemic countries

# Getting started

Log in to GitHub to determine your team number and members for Lab 3.

- Introduce yourself.
- Find a one hour block of time outside of class that you can use to work on the
lab / project if needed. You may not need to use this, but it is good to have it
in reserve. Tools like [Doodle](https://doodle.com/en/)
and [When2Meet](https://www.when2meet.com/) are helpful.
- Determine how your group will communicate (email, text, slack, discord, etc).

Every team member should now go to the course GitHub organization and locate 
your lab 3 repository, which should have the prefix **lab-03**. Clone the 
repository by copying the url in Github under the SSH tab in the `Code` drop-down 
and creating a `New Project` using version control in RStudio. If you have trouble, 
see the first lab for step-by-step instructions or ask a teammate for help.
**Do not edit the `.Rmd` file until explicitly asked to do so in the instructions.**

# Monkeypox



Monkeypox virus is endemic in central and west Africa, and in 2022 a significant global outbreak is occurring in non-endemic areas.

[Our World in Data](https://ourworldindata.org/) curates a number of really interesting data resources. In this lab we use their monkeypox data repository, which is updated daily. We start by visualizing these data. (Note: I've hidden the code below, but you can look at it in the class organization under website/docs/slides/week-03/lab-03-prob-teams.Rmd . You can change the variable `plotdate` in the  code to look at total cases per million population on another day, if desired, but this lab focuses on August 22, 2022.)


```{r mapmonkeypox, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(maps)
# https://www.who.int/emergencies/disease-outbreak-news/item/2022-DON385 lists the endemic countries with monkeypox for reference

case_series <-read.csv("https://raw.githubusercontent.com/owid/monkeypox/main/owid-monkeypox-data.csv")

world_map <- map_data("world")

#pick date to plot; note some countries may not report daily

plotdate = "2022-08-22"

#pick off date of interest to map and location names
case_map <- case_series %>%
  filter(date == plotdate) %>%
  select(location,total_cases_per_million)

# change name of location to region to match world map data, to facilitate combination of the map data with our monkeypox data
colnames(case_map)[1] <- "region"

# fix countries named differently in the mapping and monkeypox data, again in order to combine them
case_map$region[which(case_map$region == "Congo")] <- "Republic of Congo"
case_map$region[which(case_map$region == "Democratic Republic of Congo")] <- "Democratic Republic of the Congo"
case_map$region[which(case_map$region == "Czechia")] <- "Czech Republic"
case_map$region[which(case_map$region == "United Kingdom")] <- "UK"
case_map$region[which(case_map$region == "United States")] <- "USA"

#handling countries with no reported cases of monkeypox, so our map doesn't get screwed up by omitting them! We set their # of cases to NA
  if (length(setdiff(world_map$region, case_map$region)) > 0) {
    case_map_other <- as.data.frame(cbind(setdiff(world_map$region, case_map$region), NA))
    colnames(case_map_other) <- c("region", "total_cases_per_million")
    case_map <- rbind(case_map, case_map_other)
  }
#make sure cases per million is a number in R
  case_map$cpm <- as.numeric(case_map$total_cases_per_million)

#join the mapping and monkeypox case data
  case_map <- left_join(case_map, world_map, by = "region")
  
# Plot case map
  
#define plot area
  xbound = c(-180, 180)
  ybound = c(-55, 90) 

  #long, late, and group are variables in the map file itself and are used to draw the map, don't change them here
  # the monkeypox variable we use is cpm, which is cases per million for each country
  ggplot(case_map, aes(long, lat, group = group)) +
    geom_polygon(aes(fill = cpm), color = "white", size = 0.2) +
    scale_fill_viridis_c() +
    theme_linedraw() +
    theme(legend.position = "right") +
    labs(fill = "Total cases/million", title="Monkeypox Cases per Million Population", subtitle="As of August 22, 2022", x="Longitude ", y="Latitude") +
    theme(legend.direction = "vertical") +
    coord_map(xlim = xbound, ylim = ybound)



```
 

# Hot Tip

For this lab, you might want to do some pencil and paper calculations and then turn them in. If you know LaTeX-style equation coding, you can use that in R Markdown. If not, you can include an external image (e.g., a picture from your phone of your paper) easily. For example, someone in my family will be getting the following holiday gift from Snorg Tees (good advice in general!). The code to include it is below, and make sure that you save/upload the picture file in the same folder as this Rmd file:

```{r axolotl, eval=FALSE}
![](axolotl.png)
```

![](axolotl.png)



# Team workflow

Assign each team member a number 1 through 4 and write your number down on a 
piece of paper. This lab will walk you through the basics of team workflow 
step-by-step. If your team has just three members, use your favorite method (e.g., rock-paper-scissors) to randomly assign one member to be team member 4 as well.

**Do the following exercises in order, following each step carefully.**

**Only one person at a time should type in the `.Rmd` file and push updates.**

**The person working should share their screen, and the others should follow along.**

<span style="color: red;">**Team member 1:**</span> Open the `lab3.Rmd` file 
and change the author of the YAML header to the following "Team Number:
Member 1, Member 2, Member 3, Member 4" with your team number (for example Team 3) and the
first and last names of all team members.

<span style="color: red;">**Team member 1:**</span> Run the `subset-data` code 
chunk to subset the data to August 22, select only location, new cases, and total cases (not standardized to population), and print the first 6 rows and the last 6 rows. Share the results with 
your team members. Then, answer the questions below.  (For the rest of the assignment, we will consider only cases through August 22.)

```{r subset-data, message=FALSE}
library(tidyverse)

plotdate = "2022-08-22"

#pick off date of interest
case_day <- case_series %>%
  filter(date == plotdate) %>%
  select(location,new_cases,total_cases)

head(case_day,6) #you'll want to modify this line!
tail(case_day,6)
```


1. Run the code below to add up the total cases of countries in the data. Compare this to the world count provided in the data (you can see that by arranging the data from largest to smallest counts). Address the extent to which these values are consistent with each other.

```{r ex1}
# code to add up the total cases in the dataset not attributed to "World"
library(janitor)

totals <- case_day %>%
  filter(location != "World") %>%
  adorn_totals("row")

totals
```



<span style="color: red;">**Team member 1:**</span> When you have finished,
knit to PDF, then stage, commit, and push your `.Rmd` and PDF to GitHub with an
appropriate commit message.

<span style="color: red;">**All other team members:**</span> Once your team 
member has pushed the work, pull to get the updated documents from GitHub. Click
on the `.Rmd` file and you should see the responses to the first two exercises. Knit the file to update your own documents.

<span style="color: red;">**Team member 2:**</span> It's your turn. Answer the
question below.


2.  Calculate the probability that a case is from Mexico.  Then calculate the probability that a case is from the US (including Puerto Rico) and the probability a case is from Canada. In order to do these calculations, assume the sum of the reported counts in the countries (not including the World category) is the correct number of worldwide cases as of the data of interest.  (The code below shows how to calculate these percentages in R; note that Puerto Rico is reported separately from the US.) Report the probabilities up to two decimal places and include a sentence describing your findings.

```{r ex2}
options(scipen=999)
case_day %>%
  filter(location != "World") %>%
  #the mutate command creates a variable that gives the percent of total cases from each location
  mutate(percentcase=total_cases/sum(total_cases))


```

<span style="color: red;">**Team member 2:**</span> Knit to PDF, then stage, 
commit, and push your `.Rmd` and PDF to GitHub with an appropriate commit 
message.

<span style="color: red;">**All other team members:**</span> Once your team 
member has pushed the work, pull to get the updated documents from GitHub. Click
on the `.Rmd` file and you should see the responses to the first three exercises. Knit the file.

<span style="color: red;">**Team member 3:**</span> It's your turn. Complete the
exercise below.

3. Create a segmented bar chart, with each bar going from 0-1, with the country names along the y-axis and horizontal bars illustrating the fraction of new (as of August 22) and prior cases (before August 22) for each country. Use informative labels and titles. Which country has the highest percentage of new cases on August 22? Comment on whether this is a cause for major concern and why.

The starter code rearranges the cases to facilitate the plotting, creating a new dataset `tidycase`. Some plotting options are supplied to get you started, but you'll need to fill out the code to create the plot!


```{r ex3} 
# create new variable percent new cases
# store in same dataset
# change name of variable new_cases to new
case_day <- case_day %>%
  mutate(old=total_cases-new_cases, new=new_cases) %>% #this drops the old new_cases variable
  select(-new_cases)

#this formats the data for better plotting
# we'll learn more about this in data wrangling notes
# we're making two observations per country - one for new and one for old cases

tidycase <- case_day %>%
  filter(location != "World") %>% #drop entire world summaries
  pivot_longer(cols=c("new","old"),
               names_to = "type",
               values_to = "count")  %>%
  select(location, type, count) %>%
  mutate(type=as.factor(type)) 

#take a peek at new dataset
head(tidycase)

# now finally make the plot!
# this is commented out for now because it doesn't run 
# until you make edits!

#tidycase %>%
#  ggplot(aes(x = , y = , fill= )) +

# note the stat="identity" option is needed because our data
# have been summarized already (new and old cases have already
# been counted)

#  geom_bar(stat="identity",position="fill")  + 

# element text makes the font size larger or smaller; play with this

#theme(axis.text = element_text(size = 4)) +
# labs()

```


<span style="color: red;">**Team member 3:**</span> Knit to PDF, then stage,
commit, and push your `.Rmd` and PDF to GitHub with an appropriate commit
message.

<span style="color: red;">**All other team members:**</span> Once your team 
member has pushed the work, pull to get the updated documents from GitHub. Click 
on the `.Rmd` file and you should see the responses to the first four exercises.
Knit the file.

<span style="color: red;">**Team member 4:**</span> It's your turn. Complete the
exercise below.

4. What is the conditional probability that a North American monkeypox case is from Canada?  Calculate this conditional probability along with the corresponding probabilities that a North American case is from the US (including Puerto Rico) and that a North American case is from Mexico. Percentages of North American cases by country are provided by the code below.

```{r ex4}

case_day %>%
  #these are the North American countries with cases up to August 22
  filter(location %in% c("United States","Canada","Puerto Rico","Panama","Dominican Republic","Guatemala","Mexico")) %>%
  # this code calculates percent of cases from each location from the North American countries in the filter statement above
  mutate(percent=total_cases/sum(total_cases))


```



<span style="color: red;">**Team member 4:**</span> Knit to PDF, then stage, 
commit, and push your `.Rmd` and PDF to GitHub with an appropriate commit 
message.

<span style="color: red;">**All other team members:**</span> Once your team 
member has pushed the work, pull to get the updated documents from GitHub. Click 
on the `.Rmd` file and you should see the responses to the first four exercises.
Knit the file.

<span style="color: red;">**Team member 1:**</span> It's your turn again. Answer the
question below with help from your team.


5. You might wonder whether the probability that someone is a monkeypox case is related to their country  of residence. Another way to think of is to explore whether country of residence and monkeypox infection status are *independent*. Let's explore this only in North American countries that have reported at least one monkeypox case, given that monkeypox is not endemic there (we could just as easily have chosen another non-endemic continent). While ideally we would include all North American countries, for this example, we limit to the ones for which monkeypox case rates are non-zero, as otherwise we need an external source to get population size.

That is, we will get a very rough estimate of each country's population by calculating the approximate population as the number of cases divided by the cases per million population rate times one million.

Let $A$ be the event a person in this set of data is a US resident, and let $B$ be the event a person has monkeypox.  If country of residence and infection status are independent in these North American countries, then $P(A|B) = P(A)$.  If this condition is satisfied, then we'd want to check the condition for other countries in North America to be sure country and infection are independent. If the condition is not satisfied for the US, than the two variables are not independent, and we don't have to bother checking other countries.

You may find the following code helpful!





```{r ex5_setup}
# creates new dataset, data5, that contains total cases as of August 22, and population of each country, among the North American countries with cases
data5 <- case_series %>%
    filter(date == plotdate) %>%
    filter(location %in% c("United States","Canada","Puerto Rico","Panama","Dominican Republic","Guatemala","Mexico")) %>%
  mutate(approxpop = 1000000*total_cases/total_cases_per_million) %>%
  select(location,approxpop,total_cases)

data5

```



<span style="color: red;">**Team member 1:**</span> When you have finished,
knit to PDF, then stage, commit, and push your `.Rmd` and PDF to GitHub with an
appropriate commit message.

<span style="color: red;">**All other team members:**</span> Once your team 
member has pushed the work, pull to get the updated documents from GitHub. Click
on the `.Rmd` file and you should see the responses to the first two exercises. Knit the file to update your own documents.

<span style="color: red;">**Team member 2:**</span> It's your turn. Answer the
question below.

6. Now let's go back to the original data, `case_series`. The variable `new_cases` shows the number of new cases reported each day of the outbreak. Filter the data to include the country of your choice and create a scatterplot showing the case trend over time in this country. Describe this trend in a couple of sentences.

Because the variable `date` in that data set is viewed as a character rather than date variable, we first need to reformat it using the code below.




```{r ex6}
# change formatting of date from character to date format
case_series <- case_series %>% #make a change and save to dataset of same name
  mutate(date=as.Date(date,'%Y-%m-%d'))

# ggplot tip: this code below angles the x axis tick labels
# helpful if the labels overlap each other and are hard to read
# + theme(axis.text.x=element_text(angle=60, hjust=1)) 
```




<span style="color: red;">**Team member 2:**</span> When you have finished,
knit to PDF, then stage, commit, and push your `.Rmd` and PDF to GitHub with an
appropriate commit message.

<!-- for the end -->

<span style="color: red;">**All other team members:**</span> Once your team 
member has pushed the work, pull to get the updated documents from GitHub. Click
on the `.Rmd` file to see your final version of the lab. 

<span style="color: red;">**Team member 3:**</span> Upload your team's PDF to
Gradescope. Include every team member's name in the Gradescope submission and
identify which problems are on each page in Gradescope. Associate the "Overall"
section with the first page of your PDF.

There should only be one submission per team on Gradescope.




## Grading
Total: 50 pts

- Exercise 1: 7 pts
- Exercise 2: 7 pts
- Exercise 3: 7 pts
- Exercise 4: 7 pts
- Exercise 5: 7 pts
- Exercise 6: 7 pts
- Overall:  8 pts

  - Overall includes the number of commits made by different team members (at least 1 by each member), naming chunks, updating the names on the assignment to your team name clearly identifying all team members, following tidyverse style (see: https://style.tidyverse.org/), and in general producing a nicely formatted, neat report. 