<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Prediction and Overfitting</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/font-awesome/css/all.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/v4-shims.css" rel="stylesheet" />
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <link rel="stylesheet" href="css/xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="css/slides.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Prediction and Overfitting
## <br><br> Introduction to Global Health Data Science
### <br> Prof. Amy Herring

---





layout: true
  
&lt;div class="my-footer"&gt;
&lt;span&gt;
&lt;a href="https://sta-198-glhlth-298-fall-2022.github.io/website/" target="_blank"&gt;Back to website&lt;/a&gt;
&lt;/span&gt;
&lt;/div&gt; 

---







class: middle

# Prediction

---

## GATS Data


```r
gats &lt;- readr::read_csv("data/gats_rev.csv")

gats &lt;- gats %&gt;%
  filter(CURRENTSMOKE == "1") %&gt;%
  filter(TRYSTOP != "9") %&gt;%
  select(-CIGS_DAY,-CASEID,-CURRENTSMOKE,-AGESTART,-REGION6,-REGION3,-HEARDOFECIG,-ECIGUSE) %&gt;%
  filter(EDUCATION &lt; 9) %&gt;%
  filter(OCCUPATION &lt; 10) %&gt;%
  filter(HOMESMOKERULES &lt; 5) %&gt;%
  filter(SMOKESICK &lt; 3) %&gt;%
  filter(SMOKECANCER &lt; 3)

gats$RESIDENCE=factor(gats$RESIDENCE,levels=c(1,2),labels=c("Urban","Rural"))
gats$PROVINCE=factor(gats$PROVINCE,levels=seq(1:31),labels=c("Beijing","Tianjin","Hebei","Shanxi","Neimenggu","Liaoning","Jilin","Heilongjiang","Shanghai","Jiangsu","Zhejiang","Anhui","Fujian","Jiangxi","Shangdong","Henan","Hubei","Hunan","Guangdong","Guangxi","Hainan","Chongqing","Sichuan","Guizhou","Yunnan","Xizang","Shaanxi","Gansu","Qinghai","Ningxia","Xinjiang"))
gats$GENDER=factor(gats$GENDER,levels=c(1,2),labels=c("Male","Female"))
gats$EDUCATION=factor(gats$EDUCATION,levels=c(1,2,3,4,5,6,7,8,77,99),labels=c("None","Less than Primary School","Primary School","Less than Secondary School","Secondary School","High School","University","Postgraduate","Don't Know","Refused"))
gats$OCCUPATION=factor(gats$OCCUPATION,levels=c(1,2,3,4,5,6,7,8,9,10,77,99),labels=c("Farming","Government","Business","Teacher","Healthcare","Student","Soldier","Unemployed","Retired","Other","Don't Know","Refused"))
gats$TRYSTOP=factor(gats$TRYSTOP,levels=c(1,2),labels=c("Yes","No"))
gats$TRYSTOP=relevel(gats$TRYSTOP, ref = "No")
gats$TRYSTOP=as.factor(gats$TRYSTOP)
gats$HOMESMOKERULES=factor(gats$HOMESMOKERULES,levels=c(1,2,3,4,7,9),labels=c("Allowed","Not Allowed but Exceptions","Never Allowed","No Rules","Don't Know","Refused"))
gats$SMOKESICK=factor(gats$SMOKESICK,levels=c(1,2,7,9),labels=c("Yes","No","Don't Know","Refused"))
gats$SMOKECANCER=factor(gats$SMOKECANCER,levels=c(1,2,7,9),labels=c("Yes","No","Don't Know","Refused"))
gats$AGE2=gats$AGE*gats$AGE
```

---

## Goal: Predict Who Has Tried to Stop Smoking

- Data: Set of survey responses, and we know who tried to stop smoking, and who hasn't

- Use logistic regression to predict the probability that someone has tried to stop smoking

- Consider how we might compare different models in terms of predictive performance

--
- Building a model to predict the probability that someone will try to stop smoking is only half of the battle! We also need a decision rule about whom we predict to have tried to stop (e.g. what probability should we use as out cutoff?)

--

- A simple approach: choose a single threshold probability and any person who exceeds that probability is flagged as someone who may have tried to stop

---

## A multiple logistic regression approach

Let's start by including a lot of predictors in a big model.

```r
bigmod &lt;- logistic_reg() %&gt;%
  set_engine("glm") %&gt;%
  fit(TRYSTOP ~ GENDER+PROVINCE+RESIDENCE+EDUCATION+
        OCCUPATION+HOMESMOKERULES+
        SMOKESICK+SMOKECANCER+GENDER*EDUCATION + GENDER*OCCUPATION + AGE + AGE2 + AGE*GENDER + AGE2*GENDER, data = gats, family = "binomial") %&gt;%
  tidy() 
```
 
---


```r
print(bigmod,n=17)
```

```
#&gt; # A tibble: 72 × 5
#&gt;    term                 estimate std.error statistic p.value
#&gt;    &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
#&gt;  1 (Intercept)           -1.55       0.696   -2.23    0.0258
#&gt;  2 GENDERFemale          -8.10       4.30    -1.88    0.0595
#&gt;  3 PROVINCETianjin       -1.08       0.775   -1.40    0.163 
#&gt;  4 PROVINCEHebei          0.217      0.514    0.422   0.673 
#&gt;  5 PROVINCEShanxi         0.230      0.514    0.447   0.655 
#&gt;  6 PROVINCENeimenggu      0.127      0.547    0.232   0.817 
#&gt;  7 PROVINCELiaoning       0.431      0.543    0.794   0.427 
#&gt;  8 PROVINCEJilin          0.483      0.535    0.902   0.367 
#&gt;  9 PROVINCEHeilongjiang  -0.250      0.543   -0.459   0.646 
#&gt; 10 PROVINCEShanghai      -0.395      0.537   -0.737   0.461 
#&gt; 11 PROVINCEJiangsu        0.422      0.509    0.829   0.407 
#&gt; 12 PROVINCEZhejiang      -0.0430     0.542   -0.0793  0.937 
#&gt; 13 PROVINCEAnhui          0.979      0.521    1.88    0.0603
#&gt; 14 PROVINCEFujian         0.656      0.526    1.25    0.212 
#&gt; 15 PROVINCEJiangxi       -0.611      0.572   -1.07    0.285 
#&gt; 16 PROVINCEShangdong      0.310      0.513    0.604   0.546 
#&gt; 17 PROVINCEHenan          0.568      0.512    1.11    0.267 
#&gt; # … with 55 more rows
```

---


```r
print(bigmod[18:33,],n=16)
```

```
#&gt; # A tibble: 16 × 5
#&gt;    term              estimate std.error statistic p.value
#&gt;    &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
#&gt;  1 PROVINCEHubei       0.0149     0.514    0.0290  0.977 
#&gt;  2 PROVINCEHunan       0.401      0.506    0.792   0.428 
#&gt;  3 PROVINCEGuangdong   0.214      0.514    0.416   0.677 
#&gt;  4 PROVINCEGuangxi     0.794      0.527    1.51    0.132 
#&gt;  5 PROVINCEHainan      1.65       0.801    2.06    0.0394
#&gt;  6 PROVINCEChongqing  -0.270      0.540   -0.501   0.617 
#&gt;  7 PROVINCESichuan     0.222      0.503    0.441   0.659 
#&gt;  8 PROVINCEGuizhou     0.659      0.521    1.26    0.206 
#&gt;  9 PROVINCEYunnan      0.757      0.533    1.42    0.156 
#&gt; 10 PROVINCEXizang     -0.780      0.851   -0.917   0.359 
#&gt; 11 PROVINCEShaanxi     0.761      0.519    1.46    0.143 
#&gt; 12 PROVINCEGansu       0.649      0.556    1.17    0.243 
#&gt; 13 PROVINCEQinghai     1.23       0.681    1.80    0.0711
#&gt; 14 PROVINCENingxia     0.472      0.708    0.667   0.505 
#&gt; 15 PROVINCEXinjiang    0.153      0.549    0.278   0.781 
#&gt; 16 RESIDENCERural      0.0908     0.102    0.888   0.375
```

---


```r
print(bigmod[34:52,],n=19)
```

```
#&gt; # A tibble: 19 × 5
#&gt;    term                           estim…¹ std.e…² stati…³ p.value
#&gt;    &lt;chr&gt;                            &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
#&gt;  1 EDUCATIONLess than Primary Sc…  0.324    0.248  1.31   1.91e-1
#&gt;  2 EDUCATIONPrimary School         0.152    0.242  0.629  5.29e-1
#&gt;  3 EDUCATIONLess than Secondary …  0.445    0.269  1.65   9.83e-2
#&gt;  4 EDUCATIONSecondary School       0.211    0.240  0.882  3.78e-1
#&gt;  5 EDUCATIONHigh School            0.480    0.253  1.90   5.75e-2
#&gt;  6 EDUCATIONUniversity             0.210    0.275  0.763  4.46e-1
#&gt;  7 EDUCATIONPostgraduate          -1.53     1.12  -1.37   1.71e-1
#&gt;  8 OCCUPATIONGovernment            0.320    0.222  1.44   1.50e-1
#&gt;  9 OCCUPATIONBusiness              0.179    0.122  1.47   1.43e-1
#&gt; 10 OCCUPATIONTeacher               0.427    0.394  1.09   2.78e-1
#&gt; 11 OCCUPATIONHealthcare            0.420    0.364  1.15   2.49e-1
#&gt; 12 OCCUPATIONStudent              -0.978    0.720 -1.36   1.75e-1
#&gt; 13 OCCUPATIONSoldier              14.9    620.     0.0240 9.81e-1
#&gt; 14 OCCUPATIONUnemployed            0.205    0.168  1.22   2.21e-1
#&gt; 15 OCCUPATIONRetired               0.250    0.162  1.54   1.23e-1
#&gt; 16 HOMESMOKERULESNot Allowed but…  0.144    0.110  1.32   1.88e-1
#&gt; 17 HOMESMOKERULESNever Allowed     0.466    0.118  3.96   7.37e-5
#&gt; 18 HOMESMOKERULESNo Rules         -0.0119   0.111 -0.107  9.14e-1
#&gt; 19 SMOKESICKNo                    -0.330    0.166 -1.99   4.67e-2
#&gt; # … with abbreviated variable names ¹​estimate, ²​std.error,
#&gt; #   ³​statistic
```


---


```r
print(bigmod[53:72,],n=21)
```

```
#&gt; # A tibble: 20 × 5
#&gt;    term                        estimate std.er…¹ statis…² p.value
#&gt;    &lt;chr&gt;                          &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
#&gt;  1 SMOKECANCERNo               -3.59e-1  1.80e-1 -2.00     0.0454
#&gt;  2 AGE                          3.02e-2  1.71e-2  1.77     0.0773
#&gt;  3 AGE2                        -2.57e-4  1.67e-4 -1.54     0.124 
#&gt;  4 GENDERFemale:EDUCATIONLess… -5.31e-1  6.88e-1 -0.771    0.441 
#&gt;  5 GENDERFemale:EDUCATIONPrim…  6.10e-1  7.10e-1  0.859    0.390 
#&gt;  6 GENDERFemale:EDUCATIONLess…  1.04e+0  1.01e+0  1.04     0.300 
#&gt;  7 GENDERFemale:EDUCATIONSeco…  3.89e-1  8.14e-1  0.478    0.632 
#&gt;  8 GENDERFemale:EDUCATIONHigh…  1.78e+0  1.26e+0  1.41     0.158 
#&gt;  9 GENDERFemale:EDUCATIONUniv…  1.87e+1  3.22e+2  0.0580   0.954 
#&gt; 10 GENDERFemale:EDUCATIONPost… NA       NA       NA       NA     
#&gt; 11 GENDERFemale:OCCUPATIONGov… -1.83e+0  9.40e+2 -0.00194  0.998 
#&gt; 12 GENDERFemale:OCCUPATIONBus… -4.31e-1  9.44e-1 -0.457    0.648 
#&gt; 13 GENDERFemale:OCCUPATIONTea… -3.89e+0  9.40e+2 -0.00414  0.997 
#&gt; 14 GENDERFemale:OCCUPATIONHea… -1.46e+0  9.40e+2 -0.00156  0.999 
#&gt; 15 GENDERFemale:OCCUPATIONStu…  1.77e+0  9.40e+2  0.00188  0.999 
#&gt; 16 GENDERFemale:OCCUPATIONSol… NA       NA       NA       NA     
#&gt; 17 GENDERFemale:OCCUPATIONUne…  2.48e-1  5.93e-1  0.419    0.675 
#&gt; 18 GENDERFemale:OCCUPATIONRet…  1.87e-1  6.33e-1  0.296    0.767 
#&gt; 19 GENDERFemale:AGE             2.23e-1  1.37e-1  1.63     0.103 
#&gt; 20 GENDERFemale:AGE2           -1.52e-3  1.10e-3 -1.38     0.169 
#&gt; # … with abbreviated variable names ¹​std.error, ²​statistic
```



---

## Some observations

- Our model has a lot of predictors

- Some information is likely repetitive

- Some information is likely noise

- How do we pick a "best" model to get the "best" predictions?

---

## Prediction

- The mechanics of prediction are **easy**:

  - Plug in values of predictors to the model equation
  
  - Calculate the predicted value of the response variable, `\(\hat{y}\)`

--

- Getting it right is **hard**!

  - There is no guarantee the model estimates you have are correct
  
  - Or that your model will perform as well with new data as it did with your sample data

---

## Underfitting and overfitting

&lt;img src="w12-l02-prediction-overfitting_files/figure-html/unnamed-chunk-2-1.png" width="70%" style="display: block; margin: auto;" /&gt;

---

## Spending our data

- Several steps to create a useful model: parameter estimation, model selection, performance assessment, etc.

- Doing all of this on the entire data we have available can lead to **overfitting**

- Allocate specific subsets of data for different tasks, as opposed to allocating the largest possible amount to the model parameter estimation only (which is what we've done so far)

---

class: middle

# Splitting data

---

## Splitting data

- **Not-Testing set:**
  - Sandbox for model building 
  - Spend most of your time using the not-testing set to develop the model
  - Often split the not-testing set into training and validation components
  - Majority of the data (often 80%)
  
- **Testing set:**
  - Held in reserve to determine efficacy of one or two chosen models
  - Critical to look at it once, otherwise it becomes part of the modeling process
  - Remainder of the data (often 20%)
  
---

Consider the following schematic from the Tidymodels website.

&lt;img src="img/traintest.png" width="45%" style="display: block; margin: auto;" /&gt;

---

## Performing the split


```r
# Fix random numbers by setting the seed 
# Enables analysis to be reproducible when random numbers are used 
set.seed(1213)

# Put 80% of the data into the training set 
gats_split &lt;- initial_split(gats, prop = 0.80)

# Create data frames for the two sets:
nottest_data &lt;- training(gats_split)
test_data  &lt;- testing(gats_split)

# Split the non-testing data into training and validation components
nottest_split &lt;- initial_split(nottest_data,prop=0.80)
nottest_train_data &lt;- training(nottest_split)
nottest_validation_data &lt;- testing(nottest_split)
```

---

## Peek at the split

.small[
.pull-left[

```r
glimpse(nottest_train_data)
```

```
#&gt; Rows: 1,870
#&gt; Columns: 11
#&gt; $ RESIDENCE      &lt;fct&gt; Rural, Urban, Rural, Rural, Rural, Rural…
#&gt; $ PROVINCE       &lt;fct&gt; Qinghai, Zhejiang, Guizhou, Hebei, Jiang…
#&gt; $ AGE            &lt;dbl&gt; 31.79178, 64.60000, 44.58904, 65.97808, …
#&gt; $ GENDER         &lt;fct&gt; Male, Male, Male, Male, Male, Male, Male…
#&gt; $ EDUCATION      &lt;fct&gt; University, Less than Primary School, Pr…
#&gt; $ OCCUPATION     &lt;fct&gt; Business, Farming, Business, Business, R…
#&gt; $ TRYSTOP        &lt;fct&gt; Yes, No, Yes, Yes, Yes, No, Yes, No, Yes…
#&gt; $ HOMESMOKERULES &lt;fct&gt; No Rules, Allowed, Allowed, Not Allowed …
#&gt; $ SMOKESICK      &lt;fct&gt; Yes, Yes, Yes, Yes, Yes, Yes, Yes, No, Y…
#&gt; $ SMOKECANCER    &lt;fct&gt; Yes, No, Yes, Yes, Yes, Yes, Yes, No, Ye…
#&gt; $ AGE2           &lt;dbl&gt; 1010.7173, 4173.1600, 1988.1826, 4353.10…
```
]
.pull-right[

```r
glimpse(test_data)
```

```
#&gt; Rows: 585
#&gt; Columns: 11
#&gt; $ RESIDENCE      &lt;fct&gt; Urban, Urban, Urban, Urban, Urban, Urban…
#&gt; $ PROVINCE       &lt;fct&gt; Beijing, Tianjin, Tianjin, Tianjin, Neim…
#&gt; $ AGE            &lt;dbl&gt; 62.82192, 60.62740, 62.04110, 70.76438, …
#&gt; $ GENDER         &lt;fct&gt; Male, Male, Male, Male, Male, Male, Male…
#&gt; $ EDUCATION      &lt;fct&gt; University, High School, Secondary Schoo…
#&gt; $ OCCUPATION     &lt;fct&gt; Retired, Retired, Retired, Retired, Busi…
#&gt; $ TRYSTOP        &lt;fct&gt; No, No, No, Yes, No, No, Yes, No, No, No…
#&gt; $ HOMESMOKERULES &lt;fct&gt; Allowed, Not Allowed but Exceptions, All…
#&gt; $ SMOKESICK      &lt;fct&gt; Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, …
#&gt; $ SMOKECANCER    &lt;fct&gt; Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, …
#&gt; $ AGE2           &lt;dbl&gt; 3946.5934, 3675.6813, 3849.0976, 5007.59…
```
]
]

---

## Fit our model to the training dataset


```r
trystop_m1 &lt;- logistic_reg() %&gt;%
  set_engine("glm") %&gt;%
  fit(TRYSTOP ~ GENDER+PROVINCE+RESIDENCE+EDUCATION+
        OCCUPATION+HOMESMOKERULES+
        SMOKESICK+SMOKECANCER+GENDER*EDUCATION + GENDER*OCCUPATION + AGE + AGE2 + AGE*GENDER + AGE2*GENDER , data = nottest_train_data, family = "binomial") 
```

.small[

```r
trystop_m1
```

```
#&gt; parsnip model object
#&gt; 
#&gt; Fit time:  122ms 
#&gt; 
#&gt; Call:  stats::glm(formula = TRYSTOP ~ GENDER + PROVINCE + RESIDENCE + 
#&gt;     EDUCATION + OCCUPATION + HOMESMOKERULES + SMOKESICK + SMOKECANCER + 
#&gt;     GENDER * EDUCATION + GENDER * OCCUPATION + AGE + AGE2 + AGE * 
#&gt;     GENDER + AGE2 * GENDER, family = stats::binomial, data = data)
#&gt; 
#&gt; Coefficients:
#&gt;                                      (Intercept)                                      GENDERFemale  
#&gt;                                       -1.363e+00                                        -1.469e+01  
#&gt;                                  PROVINCETianjin                                     PROVINCEHebei  
#&gt;                                       -1.168e+00                                         1.100e-01  
#&gt;                                   PROVINCEShanxi                                 PROVINCENeimenggu  
#&gt;                                        1.726e-01                                         3.140e-01  
#&gt;                                 PROVINCELiaoning                                     PROVINCEJilin  
#&gt;                                        5.521e-01                                         4.319e-01  
#&gt;                             PROVINCEHeilongjiang                                  PROVINCEShanghai  
#&gt;                                       -5.421e-01                                        -2.867e-01  
#&gt;                                  PROVINCEJiangsu                                  PROVINCEZhejiang  
#&gt;                                        5.254e-01                                        -1.582e-01  
#&gt;                                    PROVINCEAnhui                                    PROVINCEFujian  
#&gt;                                        7.355e-01                                         3.609e-01  
#&gt;                                  PROVINCEJiangxi                                 PROVINCEShangdong  
#&gt;                                       -1.655e-01                                         2.447e-01  
#&gt;                                    PROVINCEHenan                                     PROVINCEHubei  
#&gt;                                        4.926e-01                                         3.008e-02  
#&gt;                                    PROVINCEHunan                                 PROVINCEGuangdong  
#&gt;                                        8.847e-02                                         1.438e-01  
#&gt;                                  PROVINCEGuangxi                                    PROVINCEHainan  
#&gt;                                        6.649e-01                                         1.266e+00  
#&gt;                                PROVINCEChongqing                                   PROVINCESichuan  
#&gt;                                       -2.884e-01                                         2.880e-01  
#&gt;                                  PROVINCEGuizhou                                    PROVINCEYunnan  
#&gt;                                        9.591e-01                                         2.250e-01  
#&gt;                                   PROVINCEXizang                                   PROVINCEShaanxi  
#&gt;                                       -9.007e-01                                         7.732e-01  
#&gt;                                    PROVINCEGansu                                   PROVINCEQinghai  
#&gt;                                        6.366e-01                                         1.506e+00  
#&gt;                                  PROVINCENingxia                                  PROVINCEXinjiang  
#&gt;                                        5.283e-01                                         3.398e-02  
#&gt;                                   RESIDENCERural                 EDUCATIONLess than Primary School  
#&gt;                                        9.761e-03                                         2.922e-01  
#&gt;                          EDUCATIONPrimary School               EDUCATIONLess than Secondary School  
#&gt;                                        3.022e-01                                         5.298e-01  
#&gt;                        EDUCATIONSecondary School                              EDUCATIONHigh School  
#&gt;                                        2.617e-01                                         4.585e-01  
#&gt;                              EDUCATIONUniversity                             EDUCATIONPostgraduate  
#&gt;                                        3.903e-01                                        -1.512e+01  
#&gt;                             OCCUPATIONGovernment                                OCCUPATIONBusiness  
#&gt;                                        1.048e-01                                         7.961e-02  
#&gt;                                OCCUPATIONTeacher                              OCCUPATIONHealthcare  
#&gt;                                       -6.793e-02                                         1.125e-01  
#&gt;                                OCCUPATIONStudent                                 OCCUPATIONSoldier  
#&gt;                                       -1.006e+00                                         1.635e+01  
#&gt;                             OCCUPATIONUnemployed                                 OCCUPATIONRetired  
#&gt;                                        1.509e-01                                        -4.512e-02  
#&gt;         HOMESMOKERULESNot Allowed but Exceptions                       HOMESMOKERULESNever Allowed  
#&gt;                                        1.636e-01                                         5.272e-01  
#&gt;                           HOMESMOKERULESNo Rules                                       SMOKESICKNo  
#&gt;                                        1.167e-01                                        -2.745e-01  
#&gt;                                    SMOKECANCERNo                                               AGE  
#&gt;                                       -3.952e-01                                         2.255e-02  
#&gt;                                             AGE2    GENDERFemale:EDUCATIONLess than Primary School  
#&gt;                                       -1.818e-04                                        -6.853e-02  
#&gt;             GENDERFemale:EDUCATIONPrimary School  GENDERFemale:EDUCATIONLess than Secondary School  
#&gt;                                        1.016e+00                                         1.830e+01  
#&gt;           GENDERFemale:EDUCATIONSecondary School                 GENDERFemale:EDUCATIONHigh School  
#&gt;                                        9.146e-01                                         3.118e+00  
#&gt;                 GENDERFemale:EDUCATIONUniversity                GENDERFemale:EDUCATIONPostgraduate  
#&gt;                                        5.493e+01                                                NA  
#&gt;                GENDERFemale:OCCUPATIONGovernment                   GENDERFemale:OCCUPATIONBusiness  
#&gt;                                               NA                                        -3.233e+01  
#&gt;                   GENDERFemale:OCCUPATIONTeacher                 GENDERFemale:OCCUPATIONHealthcare  
#&gt;                                               NA                                        -3.450e+01  
#&gt;                   GENDERFemale:OCCUPATIONStudent                    GENDERFemale:OCCUPATIONSoldier  
#&gt;                                       -3.024e+01                                                NA  
#&gt;                GENDERFemale:OCCUPATIONUnemployed                    GENDERFemale:OCCUPATIONRetired  
#&gt;                                       -1.593e+00                                        -1.526e+00  
#&gt;                                 GENDERFemale:AGE                                 GENDERFemale:AGE2  
#&gt;                                        4.072e-01                                        -2.667e-03  
#&gt; 
#&gt; Degrees of Freedom: 1869 Total (i.e. Null);  1802 Residual
#&gt; Null Deviance:	    2592 
#&gt; Residual Deviance: 2460 	AIC: 2596
```
]

---

## Predict outcome on the validation dataset


```r
predict(trystop_m1, nottest_validation_data)
```

```
#&gt; # A tibble: 468 × 1
#&gt;   .pred_class
#&gt;   &lt;fct&gt;      
#&gt; 1 No         
#&gt; 2 Yes        
#&gt; 3 No         
#&gt; 4 No         
#&gt; 5 No         
#&gt; 6 Yes        
#&gt; # … with 462 more rows
```


---

## Predict probabilities on the validation dataset


```r
trystop_pred1 &lt;- predict(trystop_m1, nottest_validation_data, type = "prob") %&gt;%
  bind_cols(nottest_validation_data %&gt;% select(TRYSTOP))

trystop_pred1
```

```
#&gt; # A tibble: 468 × 3
#&gt;   .pred_No .pred_Yes TRYSTOP
#&gt;      &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;  
#&gt; 1    0.711     0.289 Yes    
#&gt; 2    0.206     0.794 Yes    
#&gt; 3    0.538     0.462 Yes    
#&gt; 4    0.549     0.451 No     
#&gt; 5    0.803     0.197 No     
#&gt; 6    0.479     0.521 No     
#&gt; # … with 462 more rows
```

---

## A closer look at predictions

.pull-left-wide[

```r
trystop_pred1 %&gt;%
  arrange(desc(.pred_Yes)) %&gt;%
  print(n = 15)
```

```
#&gt; # A tibble: 468 × 3
#&gt;    .pred_No .pred_Yes TRYSTOP
#&gt;       &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;  
#&gt;  1 2.22e-16     1     Yes    
#&gt;  2 1.03e- 7     1.00  Yes    
#&gt;  3 1.30e- 1     0.870 No     
#&gt;  4 1.32e- 1     0.868 Yes    
#&gt;  5 1.35e- 1     0.865 Yes    
#&gt;  6 1.74e- 1     0.826 Yes    
#&gt;  7 2.03e- 1     0.797 No     
#&gt;  8 2.06e- 1     0.794 Yes    
#&gt;  9 2.46e- 1     0.754 Yes    
#&gt; 10 2.55e- 1     0.745 Yes    
#&gt; 11 2.57e- 1     0.743 Yes    
#&gt; 12 2.70e- 1     0.730 Yes    
#&gt; 13 2.73e- 1     0.727 Yes    
*#&gt; 14 2.73e- 1     0.727 Yes    
*#&gt; 15 2.74e- 1     0.726 No     
#&gt; # … with 453 more rows
```
]


---

## Evaluate the performance

**Receiver operating characteristic (ROC) curve**&lt;sup&gt;+&lt;/sup&gt; plots true positive rate vs. false positive rate (1 - specificity)

.pull-left[

```r
trystop_pred1 %&gt;%
  roc_curve(
    truth = TRYSTOP,
    .pred_Yes,
    event_level = "second"
  ) %&gt;%
  autoplot()
```
]
.pull-right[
&lt;img src="w12-l02-prediction-overfitting_files/figure-html/unnamed-chunk-12-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

.footnote[
.small[
&lt;sup&gt;+&lt;/sup&gt;Originally developed for operators of military radar receivers, hence the name.
]
]

---


## Evaluate the performance

Find the area under the curve:

.pull-left[

```r
trystop_pred1 %&gt;%
  roc_auc(
    truth = TRYSTOP,
    .pred_Yes,
    event_level = "second"
  )
```

```
#&gt; # A tibble: 1 × 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary         0.610
```
]
.pull-right[
&lt;img src="w12-l02-prediction-overfitting_files/figure-html/unnamed-chunk-14-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

OK, this is not a lot better than randomly predicting based on the prevalence of having tried to stop smoking in the data (AUC=0.5).

---

## Comparing Models

Let's compare the fit of this large model to one that does not contain any of the interaction terms.


```r
trystop_m2 &lt;- logistic_reg() %&gt;%
  set_engine("glm") %&gt;%
  fit(TRYSTOP ~ GENDER+PROVINCE+RESIDENCE+EDUCATION+
        OCCUPATION+HOMESMOKERULES+
        SMOKESICK+SMOKECANCER + AGE + AGE2, data = nottest_train_data, family = "binomial") 

trystop_pred2 &lt;- 
  predict(trystop_m2, nottest_validation_data, type = "prob") %&gt;% 
  bind_cols(nottest_validation_data %&gt;% select(TRYSTOP))
```

---

.pull-left[
"Big" model with gender, education, occupation, residence,  province, home rules, beliefs, age, interactions
&lt;img src="w12-l02-prediction-overfitting_files/figure-html/unnamed-chunk-15-1.png" width="100%" style="display: block; margin: auto;" /&gt;


```
#&gt; # A tibble: 1 × 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary         0.610
```
]
.pull-right[
Model without gender, education, occupation, and residence


&lt;img src="w12-l02-prediction-overfitting_files/figure-html/unnamed-chunk-17-1.png" width="100%" style="display: block; margin: auto;" /&gt;


```
#&gt; # A tibble: 1 × 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary         0.615
```
]

---

Here you see "bigger" isn't "better" -- we have a higher AUC and better predictive accuracy in our smaller model. 

Our bigger model may have been overfitting/"chasing the data" too much.

---

The model with only an intercept should yield an AUC of 0.5 (chance assignment).


```r
trystop_m3 &lt;- logistic_reg() %&gt;%
  set_engine("glm") %&gt;%
  fit(TRYSTOP ~ 1, data = nottest_train_data, family = "binomial") 

trystop_pred3 &lt;- predict(trystop_m3, nottest_validation_data, type = "prob") %&gt;% bind_cols(nottest_validation_data %&gt;% select(TRYSTOP))

trystop_pred3 %&gt;%
  roc_auc(
    truth = TRYSTOP,
    .pred_Yes,
    event_level = "second"
  )
```

```
#&gt; # A tibble: 1 × 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary           0.5
```
---

```r
trystop_pred3 %&gt;%
  roc_curve(
    truth = TRYSTOP,
    .pred_Yes,
    event_level = "second"
  ) %&gt;%
  autoplot()
```

&lt;img src="w12-l02-prediction-overfitting_files/figure-html/unnamed-chunk-19-1.png" width="60%" style="display: block; margin: auto;" /&gt;

---

At the end of the day, we are predicting who has tried to stop smoking better than by random chance, but this is not a highly accurate algorithm. It is possible that with additional variables, for example about motivation or other psychological factors, we could do a better job with our prediction.

---

## Checking Preferred Model

To finish, we fit our preferred model on the test data to assess its fit in the completely untouched test sample.


```r
trystop_mf &lt;- logistic_reg() %&gt;%
  set_engine("glm") %&gt;%
  fit(TRYSTOP ~ PROVINCE+HOMESMOKERULES+SMOKESICK+
        SMOKECANCER, data = nottest_data, family = "binomial") 

trystop_predf &lt;- 
  predict(trystop_mf, test_data, type = "prob") %&gt;% 
  bind_cols(test_data %&gt;% select(TRYSTOP))
```

---


```r
trystop_predf %&gt;%
  roc_curve(
    truth = TRYSTOP,
    .pred_Yes,
    event_level = "second"
  ) %&gt;%
  autoplot()
```

&lt;img src="w12-l02-prediction-overfitting_files/figure-html/finalroc-1.png" width="60%" style="display: block; margin: auto;" /&gt;

---


```r
trystop_predf %&gt;%
  roc_auc(
    truth = TRYSTOP,
    .pred_Yes,
    event_level = "second"
  )
```

```
#&gt; # A tibble: 1 × 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary         0.595
```

Our performance is similar in the completely untouched sample.  
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightLines": true,
"highlightStyle": "solarized-light",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
